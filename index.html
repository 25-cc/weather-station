---
layout: default
title: Home
---

<div class="container">
    <div class="row text-center">
        <div class="col">
            <!-- Current weather forecast (next 2h)-->
            <!-- APIs: https://data.gov.sg/collections/1456/view -->
            <div class="p-5 mb-4 bg-body-tertiary rounded-3">
                <div class="container-fluid">
                    <h1 class="display-5 fw-bold">Weather</h1>
                    <p>
                        <span id = "current_weather"></span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col">
            <!-- Wet bulb temperature and heat stress -->
            <!-- https://data.gov.sg/datasets/d_87884af1f85d702d4f74c6af13b4853d/view -->
            <div class="p-5 mb-4 bg-body-tertiary rounded-3">
                <div class="container-fluid">
                    <h1 class="display-5 fw-bold">Heat readings</h1>
                    <p>
                        Air temperature: <span id = "air_temp"></span>¬∞C
                    </p>
                    <p>
                        Humidity: <span id = "humidity"></span>%
                    </p>
                    <p>
                        Wet bulb temperature: <span id = "wet_bulb"></span>¬∞C
                    </p>
                    <p>
                        Heat stress: <span id = "heat_stress"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="row text-center">
        <div class="col">
            <!-- UV Index -->
            <!-- https://data.gov.sg/datasets/d_1b676cd174a9af4704fdb3f9aa58ff5e/view -->
            <div class="p-5 mb-4 bg-body-tertiary rounded-3">
                <div class="container-fluid">
                    <h1 class="display-5 fw-bold">UV index</h1>
                    <p>
                        Reading as of <span id = "uv_index_timestamp"></span>: <span id = "uv_index"></span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col">
            <!-- Air pollution -->
            <!-- PM2.5 API: https://data.gov.sg/datasets/d_e1058d6974c877257e32048ab128ad83/view -->
            <!-- PSI API: https://data.gov.sg/datasets/d_fe37906a0182569d891506e815e819b7/view -->
            <div class="p-5 mb-4 bg-body-tertiary rounded-3">
                <div class="container-fluid">
                    <h1 class="display-5 fw-bold">Air pollution</h1>
                    <p>
                        PM2.5: <span id = "pm25"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class = "row">
        <div class = "col">
            <div class="bg-body-tertiary rounded-3">
                <div class="container-fluid">
                    <div id="map" style="height: 500px; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class = "row">
        <div class = "col">
            <div class="accordion" id="weather_station_locations">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            Reading sources
                        </button>
                    </h2>
                </div>
                <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#weather_station_locations">
                    <div class="accordion-body">
                        <ul id = "weather_station_location_list">
                            <li>üìå Weather: <span id = "current_weather_station"></span>, updated every two hours</li>
                            <li>üìå Wet bulb temperature and heat stress: <span id = "heat_station"></span>, updated every 15 minutes</li>
                            <li>üìå Air pollution: <span id = "pollution_station"></span> Singapore, updated every 15 minutes</li> 
                            <li>üìå Air temperature: <span id = "air_temp_station"></span>, updated every 5 minutes</li>
                            <li>üìå Humidity: <span id = "humidity_station"></span>, updated every 5 minutes</li>
                            <li>üèùÔ∏è A single UV index reading is given for the whole of Singapore, updated hourly between 7am and 7pm</li>
                        </ul>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            Change location
                        </button>
                    </h2>
                </div>
                <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#weather_station_locations">
                    <div class="accordion-body">
                        <p>If the GPS reading is wrong or not available, you can manually change your location by following these instructions:
                            <ol>
                                <li>Click/tap a location on the map above.</li>
                                <li>Press the button below.</li>
                            </ol>
                        </p>
                        <p><button type="button" class="btn btn-outline-primary" id="change_location">Set new location</button></p>
                        <div id = "change_location_success_alert"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container text-center">
    <div class="row row-cols-2">
        <!-- Cards to bring the user to today's and tomorrow's forecasts on separate pages-->
        <div class="col">
            <div class="card w-90">
                <img src="/assets/images/botanics.jpg" class="card-img-top" alt="...">
                <div class="card-body">
                    <h5 class="card-title">Today's forecast</h5>
                    <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card‚Äôs content.</p>
                    <a href="#" class="btn btn-primary">Go somewhere</a>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card w-90">
                <img src="/assets/images/botanics.jpg" class="card-img-top" alt="...">
                <div class="card-body">
                    <h5 class="card-title">Tomorrow's forecast</h5>
                    <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card‚Äôs content.</p>
                    <a href="#" class="btn btn-primary">Go somewhere</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3 text-warning">
    <div id="location_error" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">‚ö†Ô∏è</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            <span id = "toast_message">Please select a location on the map before changing your location.</span>
        </div>
    </div>
</div>

<script>
    let x;
    let lat;
    let lon;
    let forecast_2h;
    let wet_bulb;
    let uv_index;
    let pm25;
    let psi;
    let air_temp;
    let humidity;
    
    function haversineDistance(lat1, lon1, lat2, lon2) {
        // Calculates the distance between two points on Earth based on the latitude and longitude of both points
        
        // To use the formula, the latitude and longitude readings have to be converted to radians
        function radian(deg) {
            // Pi radians = 180 degrees
            return deg * Math.PI / 180;
        }
        
        const earthRadius = 6371; // in kilometers
        
        // compute the distance between the two points in radians
        const dLat = radian(lat2 - lat1);
        const dLon = radian(lon2 - lon1);
        
        // Calculate haversine of the central angle between two points 
        const a = Math.pow((Math.sin(dLat/2)),2) + Math.cos(radian(lat1)) * Math.cos(radian(lat2)) * Math.pow(Math.sin(dLon/2),2);
        
        // Calculate central angle from the haversine
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        
        // Return distance in kilometers
        return earthRadius * c;
    }
    
    async function getLocation() {
        const forecast_2hr_url = "https://api-open.data.gov.sg/v2/real-time/api/two-hr-forecast"
        forecast_2h = await get_api_data(forecast_2hr_url);
        
        const wet_bulb_url = "https://api-open.data.gov.sg/v2/real-time/api/weather?api=wbgt"
        wet_bulb = await get_api_data(wet_bulb_url);
        
        const uv_index_url = 'https://api-open.data.gov.sg/v2/real-time/api/uv'
        uv_index = await get_api_data(uv_index_url);
        
        const pm25_url = "https://api-open.data.gov.sg/v2/real-time/api/pm25"
        pm25 = await get_api_data(pm25_url);
        
        const psi_url = "https://api-open.data.gov.sg/v2/real-time/api/psi"
        psi = await get_api_data(psi_url);
        
        const air_temp_url = "https://api-open.data.gov.sg/v2/real-time/api/air-temperature";
        air_temp = await get_api_data(air_temp_url);
        
        const humidity_url = "https://api-open.data.gov.sg/v2/real-time/api/rainfall";
        humidity = await get_api_data(humidity_url);
        
        if (navigator.geolocation) {
            console.log(`navigator.geolocation successful`);
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else { 
            console.log(`Geolocation is not supported by this browser`);
            x = "Error"
            // Default location is Central Water Catchment
            lat = 1.38;
            lon = 103.805;
            // document.querySelector("#display-location").innerHTML = loc;
            await getWeatherReadings(lat, lon); 
        }
    }
    
    function showPosition(position) {
        lat = position.coords.latitude
        lon = position.coords.longitude
        console.log(`${lat} ${lon}`)
        x = "Success"
        // Todo: Implement the Haversine formula for identifying the nearest weather station to user's location
        document.querySelector("#display-location").innerHTML = `${lat}, ${lon}`
        map_render();
        getWeatherReadings(lat, lon);
    }
    
    function showError(error) {
        console.log("Error in retrieving location");
        switch(error.code) {
            case error.PERMISSION_DENIED:
            x = "User denied the request for Geolocation."
            break;
            case error.POSITION_UNAVAILABLE:
            x = "Location information is unavailable."
            break;
            case error.TIMEOUT:
            x = "The request to get user location timed out."
            break;
            case error.UNKNOWN_ERROR:
            x = "An unknown error occurred."
            break;
        }
        console.log(x);
        x = "Error"
        // Default location is Central Water Catchment
        lat = 1.38;
        lon = 103.805;
        // document.querySelector("#display-location").innerHTML = loc;
        map_render();
        getWeatherReadings(lat, lon);
    }   
    
    function getWeatherReadings(userLatitude, userLongitude) {   
        let location;
        let nearestStation;
        let computedDistance;
        let shortestDistance = Infinity;
        
        
        // Use fetch to get data from the various weather APIs
        // Update the innerHTML of various parts of the site
        if (forecast_2h != undefined) {
            
            // find nearest weather station
            shortestDistance = Infinity;
            for (stn of forecast_2h.data.area_metadata) {
                computedDistance = haversineDistance(userLatitude, userLongitude, stn.label_location.latitude, stn.label_location.longitude);
                if (computedDistance < shortestDistance) {
                    shortestDistance = computedDistance;
                    nearestStation = stn.name;
                }
            }
            
            document.querySelector("#current_weather_station").innerHTML = nearestStation;
            
            // fetch the associated reading
            for (let reading of forecast_2h.data.items[0].forecasts) {
                if (reading.area == nearestStation) {
                    // based on the forecast, add some emoji to it  	
                    let weather_forecast_emoji;
                    switch (reading.forecast) {
                        case "Fair":
                        case "Fair (Day)":
                        case "Fair and Warm":
                        weather_forecast_emoji = "‚òÄÔ∏è";
                        break;
                        case "Fair (Night)":
                        weather_forecast_emoji = "üåÉ";
                        break;
                        case "Partly Cloudy":
                        case "Partly Cloudy (Day)":
                        case "Partly Cloudy (Night)":
                        case "Cloudy":
                        weather_forecast_emoji = "‚òÅÔ∏è";
                        break;
                        case "Hazy":
                        case "Slightly Hazy":
                        case "Mist":
                        case "Fog":
                        weather_forecast_emoji = "üåÅ";
                        break;
                        case "Windy":
                        weather_forecast_emoji = "üå¨Ô∏è";
                        break;
                        case "Light Rain":
                        case "Moderate Rain":
                        case "Heavy Rain":
                        case "Passing Showers":
                        case "Light Showers":
                        case "Showers":
                        case "Heavy Showers":
                        weather_forecast_emoji = "üåßÔ∏è‚òîÔ∏è";
                        break;
                        case "Thundery Showers":
                        case "Heavy Thundery Showers":
                        case "Heavy Thundery Showers with Gusty Winds":
                        weather_forecast_emoji = "‚ö°Ô∏è‚õàÔ∏è‚ö°Ô∏è";
                        break;
                    }
                    document.querySelector("#current_weather").innerHTML = `${reading.forecast} ${weather_forecast_emoji}`;
                }
            }
        }
        
        // wet bulb and heat stress readings use a different set of weather stations
        if (wet_bulb != undefined) {
            
            // find nearest weather station
            shortestDistance = Infinity;
            for (stn of wet_bulb.data.records[0].item.readings) {
                computedDistance = haversineDistance(userLatitude, userLongitude, stn.location.latitude, stn.location.longitude);
                if (computedDistance < shortestDistance) {
                    shortestDistance = computedDistance;
                    nearestStation = stn.station.name;
                }
            }
            
            document.querySelector("#heat_station").innerHTML = nearestStation;
            
            for (let reading of wet_bulb.data.records[0].item.readings) {
                if (reading.station.name == nearestStation) {
                    document.querySelector("#wet_bulb").innerHTML = reading.wbgt;
                    document.querySelector("#heat_stress").innerHTML = reading.heatStress;
                }
            }
        }
        
        // UV index is the same for the whole of Singapore      
        if (uv_index != undefined) {
            let timestamp = new Date(uv_index.data.records[0].index[0].hour)
            document.querySelector("#uv_index_timestamp").innerHTML = new Intl.DateTimeFormat("en-GB", {
                dateStyle: "short",
                timeStyle: "short",
                timeZone: "Singapore",
            }).format(timestamp);
            document.querySelector("#uv_index").innerHTML = uv_index.data.records[0].index[0].value;
        }
        
        // PM2.5 uses yet another different set of weather stations
        if (pm25 != undefined) {
            
            // find nearest weather station
            shortestDistance = Infinity;
            for (stn of pm25.data.regionMetadata) {
                computedDistance = haversineDistance(userLatitude, userLongitude, stn.labelLocation.latitude, stn.labelLocation.longitude);
                if (computedDistance < shortestDistance) {
                    shortestDistance = computedDistance;
                    nearestStation = stn.name;
                }
            }
            
            document.querySelector("#pollution_station").innerHTML = nearestStation;
            
            for (let [location, reading] of Object.entries(pm25.data.items[0].readings.pm25_one_hourly)) {
                if (location == nearestStation) {
                    document.querySelector("#pm25").innerHTML = reading
                }
            }
        }
        
        // PSI uses the same stations as PM2.5
        // PSI computation: https://www.haze.gov.sg/docs/default-source/faq/computation-of-the-pollutant-standards-index-(psi).pdf
        if (psi != undefined) {
            // skip finding the nearest weather station, reuse nearestStation as defined by PM2.5
        }
        
        // Air temperature
        if (air_temp != undefined) {
            
            // find nearest weather station
            shortestDistance = Infinity;
            for (stn of air_temp.data.stations) {
                computedDistance = haversineDistance(userLatitude, userLongitude, stn.location.latitude, stn.location.longitude);
                if (computedDistance < shortestDistance) {
                    shortestDistance = computedDistance;
                    nearestStation = stn.id;
                    document.querySelector("#air_temp_station").innerHTML = stn.name;
                }
            }
            
            for (let reading of air_temp.data.readings[0].data) {
                if (reading.stationId == nearestStation) {
                    document.querySelector("#air_temp").innerHTML = reading.value
                }
            }
        }
        
        // Humidity
        if (humidity != undefined) {
            
            // find nearest weather station
            shortestDistance = Infinity;
            for (stn of humidity.data.stations) {
                computedDistance = haversineDistance(userLatitude, userLongitude, stn.location.latitude, stn.location.longitude);
                if (computedDistance < shortestDistance) {
                    shortestDistance = computedDistance;
                    nearestStation = stn.id;
                    document.querySelector("#humidity_station").innerHTML = stn.name;
                }
            }
            
            for (let reading of humidity.data.readings[0].data) {
                if (reading.stationId == nearestStation) {
                    document.querySelector("#humidity").innerHTML = reading.value
                }
            }
        }
    }
    
    async function get_api_data(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Error occured. Response code ${response.status}`);
            }
            const result = await response.json();
            if (result.code != 0) {
                throw new Error (`Unable to fetch data from API. Error message: ${result.errorMsg}`)
                return undefined;
            } else {
                return result;
            }
        }
        catch (error) {
            console.error(error.message);
            return undefined;
        }
    }
    
    let map;
    let marker;
    let mapLat;
    let mapLon;
    
    // Map functions related to selecting your location
    function map_render() {
        map = L.map('map', {center: [lat, lon], zoom: 13, trackResize: false});
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        
        marker = L.marker([lat, lon]).addTo(map);
        marker.bindTooltip("Current location").openTooltip();
        
        var popup = L.popup();
        
        function onMapClick(e) {
            mapLat = e.latlng.lat;
            mapLon = e.latlng.lng;
            
            popup
            .setLatLng(e.latlng)
            .setContent(`Location: ${mapLat}, ${mapLon}`)
            .openOn(map);
        }
        
        map.on('click', onMapClick);
    }
    
    getLocation();
    
    const change_location_button = document.querySelector("#change_location");
    const change_location_error_toast = document.querySelector("#location_error");
    
    change_location_button.addEventListener("click", () => {
        if (mapLat == undefined || mapLon == undefined) {
            const toastInstance = bootstrap.Toast.getOrCreateInstance(change_location_error_toast)
            toastInstance.show();
            return;
        } else {
            // todo: add an additional prompt to confirm that the user wants to move to the new location
            if (confirm(`Change location to${mapLat}, ${mapLon}?`)) {
                // reassign lat and lon to the user-selected values
                lat = mapLat;
                lon = mapLon;
                
                // move the old marker to the new location
                marker.setLatLng([lat, lon]);
                
                // add an alert that the location has been changed successfully.
                const change_location_success_alert = document.querySelector('#change_location_success_alert')
                const appendAlert = (message, type) => {
                    const wrapper = document.createElement('div')
                    wrapper.innerHTML = [
                    `<div class="alert alert-${type} alert-dismissible" role="alert">`,
                        `   <div>${message}</div>`,
                        '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                        '</div>'
                        ].join('')
                        
                        change_location_success_alert.append(wrapper)
                    }
                    
                    appendAlert('Location updated!', 'success')
                    
                    return getWeatherReadings(lat, lon);
                } else {
                    const toastInstance = bootstrap.Toast.getOrCreateInstance(change_location_error_toast)
                    document.querySelector("#toast_message").innerHTML = "Please reselect your location and try again."
                    toastInstance.show();
                    return;
                }   
            }
        })
    </script>
    
    
    <!-- List of parks -->
    <!-- APIs: 
    NEA Parks https://data.gov.sg/datasets/d_0542d48f0991541706b58059381a6eca/view
    NEA Park Facilities https://data.gov.sg/datasets/d_14d807e20158338fd578c2913953516e/view
    HPB Parks@SG https://data.gov.sg/datasets/d_99b71f5d34cf57a3a592fbfdef1f42b6/view
    -->